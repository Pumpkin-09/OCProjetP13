name: CI Pipeline

# Permissions minimales d√©clar√©es au niveau du workflow
permissions:
  contents: read
  packages: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/oc-lettings

jobs:
  test:
    runs-on: ubuntu-24.04
    env:
      DJANGO_SECRET_KEY: ${{ secrets.SECRET_KEY }}
      DEBUG: False
      ALLOWED_HOSTS: localhost,127.0.0.1
    steps:
      # Actions √©pingl√©es par SHA
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Installer Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: Installer les d√©pendances
        run: pip install -r requirements.txt

      - name: Linting
        run: flake8 .

      - name: Lancer et v√©rifier la couverture des tests
        run: pytest -v --cov=. --cov-report=term --cov-fail-under=80

  

  # JOB 4 : D√©ploiement sur Render
  deploy-to-render:

    runs-on: ubuntu-24.04
    
    steps:
      - name: Trigger Render deployment
        run: |
          echo "D√©clenchement du d√©ploiement sur Render..."
          curl -X POST "${{ secrets.DEPLOY_HOOK }}"
          echo "‚úÖ D√©ploiement d√©clench√© sur Render!"
      
      - name: Wait for deployment
        run: |
          echo "Attente de 60 secondes pour le d√©ploiement..."
          sleep 60
      
      - name: Deployment info
        run: |
          echo "‚úÖ Pipeline CI/CD termin√© avec succ√®s!"
          echo "üöÄ Application d√©ploy√©e sur Render"
